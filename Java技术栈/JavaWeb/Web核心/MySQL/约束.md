- 外键约束

本章节我们先来学习外键约束，首先我们要先介绍下为什么又外键约束。当表与表的数据有关联性的时候，如果没有外键约束，那么就无法保证数据的准确性。比如假设我们有两个数据表，一个是订单表orderlist，另一个是用户表user，我们用户表的id和uid关联，id和uid一致就表示这个订单是谁的，比如在下图中，张三的就拥有12两个订单，有了这个外键约束，我们就可以确保我们的用户表中的用户在有关联的时候，不会被随意的删除，订单中的订单也不会随意添加一个没有对应id的uid订单

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE56d52e6d4d4a3a09c02cb7242c9d7f51.png)

简而言之，外键约束的作用就是让表与表之间产生关联关系，从而保证数据的准确性。接下来请看下图关于外键约束的语法

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE8f9c639ae9b818d96de8d5f2a30f0f10.png)

创建外键约束的方式有两种，一种是在创建数据表的时候创建约束，另一种是建表之后单独添加外键约束，两种方法用的本质语法都是大差不差的，都是也要用CONSTRAINT 外键名 FOREIGN KEY(本表外键列名) REFERENCES 主表名(主键列名)。我们要区分谁是主表的话，可以简单记住一点，谁调用外键约束创建命令，谁就不是主表。这样会好记很多

而由于我们这里都是对标进行的操作，因此最开头自然也是要加上ALTER TABLE的这个字段，有删除的话还要加上DROP关键字

当我们成功构建了一个约束关系之后，我们再来查看表

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE9a0dca8476e953b1121012488bba5452.png)

我们会发现这个表对应的有约束的部分的上方多了个钥匙扣住了两个表的感觉，这就用图形告诉了我们，这里有约束

我们可以构造示例代码如下

```
-- 创建db2数据库
        CREATE DATABASE db2;

        -- 使用db2数据库
        USE db2;

/*
   外键约束
   标准语法：
      CONSTRAINT 外键名 FOREIGN KEY (本表外键列名) REFERENCES 主表名(主表主键列名)
*/
        -- 建表时添加外键约束
        -- 创建user用户表
        CREATE TABLE USER(
        id INT PRIMARY KEY AUTO_INCREMENT,    -- id
        NAME VARCHAR(20) NOT NULL             -- 姓名
        );
        -- 添加用户数据
        INSERT INTO USER VALUES (NULL,'张三'),(NULL,'李四');

        -- 创建orderlist订单表
        CREATE TABLE orderlist(
        id INT PRIMARY KEY AUTO_INCREMENT,    -- id
        number VARCHAR(20) NOT NULL,          -- 订单编号
        uid INT,               -- 外键列
        CONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id)
        );
        -- 添加订单数据
        INSERT INTO orderlist VALUES (NULL,'hm001',1),(NULL,'hm002',1),
        (NULL,'hm003',2),(NULL,'hm004',2);


        -- 添加一个订单，但是没有真实用户。添加失败
        INSERT INTO orderlist VALUES (NULL,'hm005',3);

        -- 删除李四用户。删除失败
        DELETE FROM USER WHERE NAME='李四';




/*
   删除外键约束
   标准语法：
      ALTER TABLE 表名 DROP FOREIGN KEY 外键名;
*/
        -- 删除外键约束
        ALTER TABLE orderlist DROP FOREIGN KEY ou_fk1;


/*
   建表后单独添加外键约束
   标准语法：
      ALTER TABLE 表名 ADD CONSTRAINT 外键名 FOREIGN KEY (本表外键列名) REFERENCES 主表名(主键列名);
*/
        -- 添加外键约束
        ALTER TABLE orderlist ADD CONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id);
```

- 外键级联操作

什么是外键级联操作呢？其实就是两个，一是级联更新，二是级联删除。所谓级联更新，就是当主表中的数据进行修改的时候，从表的数据也会随之修改。而级联删除也是如此。虽然很方便，但是实际开发中不怎么用，因为其总是牵一发而动全身，不好管理我们的数据

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEc30458455564300eb2d9cfd82b27945f.png)

本节内容只做了解，我们来看看语法

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE25425d7a787d88d1b087748fa3675c26.png)

最后我们可以构造演示代码如下

```
/*
   添加外键约束，同时添加级联更新  标准语法：
   ALTER TABLE 表名 ADD CONSTRAINT 外键名 FOREIGN KEY (本表外键列名) REFERENCES 主表名(主键列名) 
   ON UPDATE CASCADE;
   
   添加外键约束，同时添加级联删除  标准语法：
   ALTER TABLE 表名 ADD CONSTRAINT 外键名 FOREIGN KEY (本表外键列名) REFERENCES 主表名(主键列名) 
   ON DELETE CASCADE;
   
   添加外键约束，同时添加级联更新和级联删除  标准语法：
   ALTER TABLE 表名 ADD CONSTRAINT 外键名 FOREIGN KEY (本表外键列名) REFERENCES 主表名(主键列名) 
   ON UPDATE CASCADE ON DELETE CASCADE;
*/
-- 删除外键约束
        ALTER TABLE orderlist DROP FOREIGN KEY ou_fk1;

        -- 添加外键约束，同时添加级联更新和级联删除
        ALTER TABLE orderlist ADD CONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id)
        ON UPDATE CASCADE ON DELETE CASCADE;


        -- 将李四这个用户的id修改为3,订单表中的uid也自动修改
        UPDATE USER SET id=3 WHERE id=2;

        -- 将李四这个用户删除,订单表中的该用户所属的订单也自动删除
        DELETE FROM USER WHERE id=3;
```

- 约束

我们先来学习下什么是约束，约束就是对表中的数据进行限定，保证数据的正确、有效和完整。比如我们可以约束一列的数据是不可重复的等等内容

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEa8f2dc11197075ff0bd099fa592347b3.png)

约束有四个重要关键字，分别是PRIMARY KEY(主键约束)、PRIMARY KEY AUTO_INCREMENT(主键自增)、UNIQUE(唯一约束)、NOT NULL(非空约束)。我们接下来一一学习这四个关键字

- 主键约束

主键约束有以下三个特点，1、主键约束默认该主键必须是非空和唯一的。2、一张表只能有一个主键。3、主键一般用于表中数据的唯一标识

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE90cf70ad44f2321c3a8b1eff5a769b96.png)

我们添加主键约束有两种方式，一种是建表时添加，语法是在对应的数据类型上添加上PRIMARY KEY关键词。另外一种是建表后单独添加主键约束，其语法是ALTER TABLE 表明 MODIFY 列名 数据类型 PRIMARY KEY，当然我们也可以删除主键约束，其语法就是和DROP关键词绑定罢了。

我们可以构造示例代码如下

```
-- 创建学生表(编号、姓名、年龄)  编号设为主键
        CREATE TABLE student(
        id INT PRIMARY KEY,
        NAME VARCHAR(30),
        age INT
        );

        -- 查询学生表的详细信息
        DESC student;

        -- 添加数据
        INSERT INTO student VALUES (1,'张三',23);
        INSERT INTO student VALUES (2,'李四',24);

        -- 删除主键
        ALTER TABLE student DROP PRIMARY KEY;

        -- 建表后单独添加主键约束
        ALTER TABLE student MODIFY id INT PRIMARY KEY;
```

- 主键自增约束

所谓主键自增约束，其实就是说会自动增长的意思。其语法是AUTO_INCREMENT，其添加删除语法其实和上一节学习的主键约束差不多

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE05b897766e904dbc836ddefc7117d5f3.png)

这里有一点必须提一下，就是MySQL里的自增约束，必须配合键的约束一起使用，这个键的约束不一定要是主键约束，可以是其他约束，但是自增约束是不能独立使用的。还有就是其删除主键自增约束调用的命令是MODIFY，其本质是将自增约束修改为无，而不删除主键。从其中没有调用DROP我们也能够看出端倪

那么我们可以构造其示例代码如下

```
-- 创建学生表(编号、姓名、年龄)  编号设为主键自增
        CREATE TABLE student(
        id INT PRIMARY KEY AUTO_INCREMENT,
        NAME VARCHAR(30),
        age INT
        );

        -- 查询学生表的详细信息
        DESC student;

        -- 添加数据
        INSERT INTO suudent VALUES (NULL,'张三',23),(NULL,'李四',24);

        -- 删除自增约束
        ALTER TABLE student MODIFY id INT;
        INSERT INTO student VALUES (NULL,'张三',23);

        -- 建表后单独添加自增约束
        ALTER TABLE student MODIFY id INT AUTO_INCREMENT;
```

最后我们要提一点的是，自增约束是中，其逐渐增加的值是根据其自身所用过的值的，而不是列表中目前存在的值的。简单来说，如果我们创建了一个学生，其自增的值到了3，之后我们删除掉这个3，再创建一个用户，其自增值会到达4，而不是3。同时当我们的自增约束和主键约束一起用的时候，我们可以往里面插入null值

- 唯一约束

唯一约束其实就是让我们的值变得唯一，不能允许存在相同的值。其创建的方式跟此前的差不多，关键词是UNIQUE

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEb6f535fff62da3c5ecbbaf4f1de4669c.png)

这里值得特别说一下删除，删除不是简单的和DROP绑定的，而是和DROP INDEX绑定的，这个要记住，感觉也只有这个唯一约束的删除方式比较特殊

那么我们可以构造示例代码如下：

```
-- 创建学生表(编号、姓名、年龄)  编号设为主键自增，年龄设为唯一
        CREATE TABLE student(
        id INT PRIMARY KEY AUTO_INCREMENT,
        NAME VARCHAR(30),
        age INT UNIQUE
        );


        -- 查询学生表的详细信息
        DESC student;

        -- 添加数据
        INSERT INTO student VALUES (NULL,'张三',23);
        INSERT INTO student VALUES (NULL,'李四',23);

        -- 删除唯一约束
        ALTER TABLE student DROP INDEX age;

        -- 建表后单独添加唯一约束
        ALTER TABLE student MODIFY age INT UNIQUE;

```

这里我们还要提一下，当我添加唯一约束的时候，要确保本身我们的数据满足唯一的约束的条件，才能添加成功。简单来说，你不能往已经有两个重复元素的变量里增加唯一约束，这肯定报错的。

- 非空约束

非空约束其实就是规定我们的变量不能为null值，关键字是NOT NULL，其删除采用的是MODIFY，同时如果我们给一个null值的列赋予非空约束，其可以成功，但会有警告，同时将为null值的变量改为空值，没有任何数据，但不是null

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE284a4ab1e888009ddb6ea71efaccbcc4.png)

其示例代码如下

```
-- 创建学生表(编号、姓名、年龄)  编号设为主键自增，姓名设为非空，年龄设为唯一
        CREATE TABLE student(
        id INT PRIMARY KEY AUTO_INCREMENT,
        NAME VARCHAR(30) NOT NULL,
        age INT UNIQUE
        );

        -- 查询学生表的详细信息
        DESC student;

        -- 添加数据
        INSERT INTO student VALUES (NULL,'张三',23);

        -- 删除非空约束
        ALTER TABLE student MODIFY NAME VARCHAR(30);
        INSERT INTO student VALUES (NULL,NULL,25);

        -- 建表后单独添加非空约束
        ALTER TABLE student MODIFY NAME VARCHAR(30) NOT NULL;
```

