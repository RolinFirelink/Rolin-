接下来我们就要学习来开发移动端的内容了，当然我们这里客户端上还有订单明细这一份代码我们还没有开发，但是这个不着急，我们做到最后再来开发也不着急，因为现在我们的下单方法都还没开发

然后我们一般在移动端登录都是使用验证码，我们这里一般验证码可以使用一些大公司提供给我们的短信服务来完成，请看完成步骤

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE1b9a5f3a3fcc4cbabdbeaef7abb94a69.png)

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE4dae2ee1190b37e386f4f376d1362294.png)

但是呢，我们现在还只是学习阶段，属实是没有必要真的整一个短信服务来，我们这里了解下上面的内容即可，具体的登录过程我们直接模拟即可

我们这里进入到我们阿里的账户中直接进行一个对应id的创建，注意选择使用API调用，获得对应的账号密码之后放到阿里提供给我们的工具类中使用即可（这里就不多提了，想要了解的可以自己重新去看P80之后的内容）

- 手机验证码登录

然后我们来正式实现手机验证码登录的功能，首先我们来进行需求分析

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE464f4d6ca5b55c21ee0a8770cd173b57.png)

然后我们来看看我们数据表中的用户user表，这是我们的移动端登录会涉及到的表

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE7ebee429856c056184bebe9fe2457d86.png)

接着我们来梳理下登录与后端服务器的交互过程

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE1d96d4674d8de3371170e8da0708746e.png)

然后来看看我们的代码开发的准备工作，很多类在课程中都已经写好了，我们直接用就可以了

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEbf436a1f13fd7faaae34c8ad52d57628.png)

为了让工具类不报红，我们需要在maven中导入这两个坐标

```
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>aliyun-java-sdk-core</artifactId>
    <version>4.5.16</version>
</dependency>

<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>aliyun-java-sdk-dysmsapi</artifactId>
    <version>2.1.0</version>
</dependency>
```

我们的工具类在课程中都有所提供了，我们这里直接导入即可

然后我们来学习移动端登录，移动端登录我们首先要对我们的过滤类进行一个修改，首先我们要加入两个不被拦截的请求，这两个请求分别是请求验证码和登录的请求，这两个如果不拦截，那么我们发送这个请求就立刻跳回登录页面的话就没意义了

那么首先我们需要在定义不需要处理的请求路径中加入这两个请求的路径

```
//定义不需要处理的请求路径
String[] urls = new String[]{
        "/employee/login",//登录
        "/employee/logout",//登出
        "/backend/**",//请求静态资源
        "/front/**",//请求前端静态资源
        "/common/**",
        "/user/sendMsg",
        "/user/login"
};
```

然后我们还需要在写一个方法来处理移动端用户的登录，这里的逻辑和之前电脑端登录的代码的运行逻辑是一样的

```
//4.2 判断登录状态，如果已登录则直接放行
if(request.getSession().getAttribute("user")!=null){
    log.info("用户已登录，用户id为:{}",request.getSession().getAttribute("user"));

    Long userId = (Long) request.getSession().getAttribute("user");
    BaseContext.setCurrentId(userId);

    filterChain.doFilter(request,response);
    return;
}
```

接着我们来实现获取验证码的代码（注意在我们的控制类中应该要拥有服务类作为其私有属性）

```
/**
 * 移动端登录方法
 * @param user
 * @param session
 * @return
 */
@PostMapping("/sendMsg")
public R<String> sendMsg(@RequestBody User user, HttpSession session){
    //获取手机号
    String phone = user.getPhone();

    if(!StringUtils.isEmpty(phone)){
        //生成随机的4位验证码
        String code = ValidateCodeUtils.generateValidateCode(4).toString();
        log.info("code={}",code);

        //调用阿里云提供的短信服务API完成发送短信
        //SMSUtils.sendMessage("瑞吉外卖","",phone,code);

        //将需要生成的验证码保存到Session
        session.setAttribute(phone,code);

        return R.success("手机验证短信发送成功");
    }

    return R.error("短信发送失败");
}
```

我们的代码逻辑非常简单，先获取手机号，然后调用工具类生成随机的四位验证码，接着原本的情况是我应该要调用阿里云的短信服务向我们的手机发送短信，但是要花钱，我反正懒得，我们这里使用模拟的方式，直接在控制台上打印验证码，到时候发送了验证码我们直接去服务器上看就完了，然后我们将生成的验证码保存到Session中，返回一个成功的对象信息，如果没进去则返回出错信息

接着我们来实现我们的登录方法本身，我们这里要注意我们的登录请求会传送一个带有手机号和验证码的数据，我们直接用User对象是无法承接的，我们这里可以用dto对象来承接，但是这样有些麻烦，偷懒的方法是直接用map对象承接，我们这里就使用这种方法

```
@PostMapping("/login")
public R<User> login(@RequestBody Map map,HttpSession session){
    log.info(map.toString());

    //获取手机号
    String phone = map.get("phone").toString();

    //获取验证码
    String code = map.get("code").toString();

    //从Session中获取保存的验证码
    Object codeInSession = session.getAttribute(phone);

    //进行验证码的比对(页面提交的验证码和Session中保存的验证码比对)
    if(codeInSession != null && codeInSession.equals(code)){
        //比对成功则说明登录成功

        LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(User::getPhone,phone);

        User user = userService.getOne(queryWrapper);
        if(user == null){
            //判断当前手机号对应的用户是否为新用户，如果是新用户则自动完成注册
            user = new User();
            user.setPhone(phone);
            user.setStatus(1);
            userService.save(user);
        }
        session.setAttribute("user",user.getId());
        return R.success(user);
    }
    return R.error("登录失败");
}
```

我们取出手机号和验证码，然后取出保存在Session中的验证码，接着进行验证码比对，若比对成功则说明登录成功，此时我们从数据库中查询对应的手机号，若无则直接创建保存，相当于注册，登录成功之后将对应的用户id保存到session中表示其已经登录成功了





