到了这里就是MySQL高级的内容了，其实只有增删改查是初级也是最重要的内容。后面学习的都属于暂时的了解性质的，以后再掌握，现在并不着急。其实主要是因为面试官会问，那我们现在先学习下也无妨。本章我们学习存储过程和存储函数

- 存储过程和函数的介绍

其实，简单来说，存储过程和函数，其实就类似于java中的方法，其是事先经过编译并存储在数据库中的一段SQL语句的集合。存储过程和函数存在的好处有三个，一是能提高代码的复用性、二是能减少数据库和应用服务器之间的传输，提高效率、三是减少代码层面的业务处理。因为简单的代码在数据库层面就已经被处理了。我们的存储过程和函数不但能在里面定义方法，甚至可以在里面定义变量、循环等。

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEfb076801af2e0a12aaa5ba2d1570c2b3.png)

最后我们要来说下存储过程和函数的区别，其实就是存储函数必须有返回值，而存储过程可以没有。

在我们学习之前，我们要做一些数据准备，请看用于数据准备的代码

```
-- 创建db6数据库
        CREATE DATABASE db6;

        -- 使用db6数据库
        USE db6;

        -- 创建学生表
        CREATE TABLE student(
        id INT PRIMARY KEY AUTO_INCREMENT, -- 学生id
        NAME VARCHAR(20),        -- 学生姓名
        age INT,            -- 学生年龄
        gender VARCHAR(5),       -- 学生性别
        score INT                               -- 学生成绩
        );
        -- 添加数据
        INSERT INTO student VALUES (NULL,'张三',23,'男',95),(NULL,'李四',24,'男',98),
        (NULL,'王五',25,'女',100),(NULL,'赵六',26,'女',90);




        -- 按照性别进行分组，查询每组学生的总成绩。按照总成绩的升序排序
        SELECT gender,SUM(score) getSum FROM student GROUP BY gender ORDER BY getSum ASC;
```

- 创建和调用存储过程

创建存储过程要使用到DELIMITER关键字，这个关键字的作用是定义一个结束符号，这个结束符号可以用于让我们的程序知道我们的语句到底执行到哪里结束。由于是创建，自然要用到CREATE，存储过程的关键字是PROCEDURE，与java类似，我们可以自己定义调用这个方法是否需要传入参数

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEb786a49eaa5305e2eab292fc9f4d31e4.png)

调用函数的方式很简单，CALL 存储过程名称(实际参数)

请看示例代码

```
/*
   创建存储过程

   -- 修改分隔符为$
   DELIMITER $

   -- 标准语法
   CREATE PROCEDURE 存储过程名称(参数列表)
   BEGIN
      SQL 语句列表;
   END$

   -- 修改分隔符为分号
   DELIMITER ;
*/
-- 创建stu_group()存储过程，封装 分组查询总成绩，并按照总成绩升序排序的功能
DELIMITER $

CREATE PROCEDURE stu_group()
BEGIN
        SELECT gender,SUM(score) getSum FROM student GROUP BY gender ORDER BY getSum ASC;
END$

DELIMITER ;

/*
   调用存储过程
   CALL 存储过程名称(实际参数);
*/
        -- 调用stu_group()存储过程
        CALL stu_group();
```

我们这里生成存储过程的过程是将前面的按照性别将学生分组并计算总和的成绩拿出来生成一个存储过程，之后我们调用这个存储过程。生成的存储过程可以再SQLyog左侧中看到

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE04ef2083a7f0ff0e4fa2c7e9505ecea5.png)

- 查看和删除存储过程

学会了创建存储过程之后，自然地，我们接下来就要学习如何查看和删除存储过程。查看数据库的语法是SELECT * FROM mysql.proc WHERE db='数据库名称'，其中proc是PROCEDURE的缩写，代表存储过程。删除过程就不提了，自己看吧

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE861ee916e6e5f371bacc2b80811e9f79.png)

请看示例代码

```
/*
   查询数据库中所有的存储过程
   SELECT * FROM mysql.proc WHERE db='数据库名称';
*/
-- 查看db6数据库中所有的存储过程
        SELECT * FROM mysql.proc WHERE db='db6';



/*
   删除存储过程
   DROP PROCEDURE [IF EXISTS] 存储过程名称;
*/
        DROP PROCEDURE IF EXISTS stu_group;
```

我们运行查看的代码，可以看到其下会显示以下内容

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEd3fe95cd3c07fcd0f47f610caa7a4d94.png)

这和我们查看数据库的情况是十分相同的，其实，我们查看存储过程，也就很相当于是查看我们的数据表或者是数据库。

- 变量的使用

关于变量的使用无非也就是变量的定义和赋值，在存储过程中定义变量要使用DECLARE关键字，后面接变量名和数据类型，赋予的默认值可以自己指定，当然，也可以不指定。赋值方式最简单的赋值方式是使用SET

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEa5d87d454aff9bed7891fcd332d8f5af.png)

第二种赋值方式最值得说道，第二种赋值方式是SELECT 列名 INTO 变量名 FROM 表名 [WHERE条件]，这里INTO执行的是赋值动作，其会将SELECT后面得到的结果赋值到我们的变量上。用这种方式虽然长了点，但是好处在于其可以动态获取我们某些表的数据并进行赋值

示例代码如下

```
/*
   定义变量
   DECLARE 变量名 数据类型 [DEFAULT 默认值];
*/
-- 定义一个int类型变量，并赋默认值为10
        DELIMITER $

        CREATE PROCEDURE pro_test1()
        BEGIN
        -- 定义变量
        DECLARE num INT DEFAULT 10;
        -- 使用变量
        SELECT num;
        END$

        DELIMITER ;

        -- 调用pro_test1存储过程
        CALL pro_test1();



/*
   变量赋值-方式一
   SET 变量名 = 变量值;
*/
        -- 定义一个varchar类型变量并赋值
        DELIMITER $

        CREATE PROCEDURE pro_test2()
        BEGIN
        -- 定义变量
        DECLARE NAME VARCHAR(10);
        -- 为变量赋值
        SET NAME = '存储过程';
        -- 使用变量
        SELECT NAME;
        END$

        DELIMITER ;

        -- 调用pro_test2存储过程
        CALL pro_test2();




/*
   变量赋值-方式二
   SELECT 列名 INTO 变量名 FROM 表名 [WHERE 条件];
*/
        -- 定义两个int变量，用于存储男女同学的总分数
        DELIMITER $

        CREATE PROCEDURE pro_test3()
        BEGIN
        -- 定义两个变量
        DECLARE men,women INT;
        -- 查询男同学的总分数，为men赋值
        SELECT SUM(score) INTO men FROM student WHERE gender='男';
        -- 查询女同学的总分数，为women赋值
        SELECT SUM(score) INTO women FROM student WHERE gender='女';
        -- 使用变量
        SELECT men,women;
        END$

        DELIMITER ;

        -- 调用pro_test3存储过程
        CALL pro_test3();
```

- if语句的使用

在存储过程中我们同样也可以定义if语句，这个用法其实和Linux的非常像，都是有THEN的，具体的使用规则请看下图

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCEf7e37de21322304bbe35928827b3b8e3.png)

我们可以写入其示例代码如下

```
/*
   if语句
   IF 判断条件1 THEN 执行的sql语句1;
   [ELSEIF 判断条件2 THEN 执行的sql语句2;]
   ...
   [ELSE 执行的sql语句n;]
   END IF;
*/

/*
   定义一个int变量，用于存储班级总成绩
   定义一个varchar变量，用于存储分数描述
   根据总成绩判断：
      380分及以上   学习优秀
      320 ~ 380     学习不错
      320以下       学习一般
*/
DELIMITER $

        CREATE PROCEDURE pro_test4()
        BEGIN
        -- 定义变量
        DECLARE total INT;
        DECLARE info VARCHAR(10);
        -- 查询总成绩，为total赋值
        SELECT SUM(score) INTO total FROM student;
        -- 对总成绩判断
        IF total > 380 THEN
        SET info = '学习优秀';
        ELSEIF total >= 320 AND total <= 380 THEN
        SET info = '学习不错';
        ELSE
        SET info = '学习一般';
        END IF;
        -- 查询总成绩和描述信息
        SELECT total,info;
        END$

        DELIMITER ;




        -- 调用pro_test4存储过程
        CALL pro_test4();
```

这里我们是先获得总成绩，然后利用if语句对总成绩进行一个判断，并执行判断中对应的动作。

- 参数传递的使用

在MySQL中，参数传递有三种，一种是IN，其代表输入参数，需要有调用者传入实际的数据，同时也这是默认的参数传递类型，也就是说，如果前面没有指定任何的参数传递类型，那么默认其就是输入参数，需要调用者传入。而OUT代表输入参数，该参数可以作为返回值。而INOUT既可以代表输入参数，也可以作为输出参数

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE03a7c708589c78cf186487d46ec34cbf.png)

我们这里主要演示IN和OUT，请看示例代码

```
/*
   参数传递
   CREATE PROCEDURE 存储过程名称([IN|OUT|INOUT] 参数名 数据类型)
   BEGIN
      SQL 语句列表;
   END$
*/
/*
   输入总成绩变量，代表学生总成绩
   输出分数描述变量，代表学生总成绩的描述信息
   根据总成绩判断：
      380分及以上  学习优秀
      320 ~ 380    学习不错
      320以下      学习一般
*/
DELIMITER $

        CREATE PROCEDURE pro_test5(IN total INT,OUT info VARCHAR(10))
        BEGIN
        -- 对总成绩判断
        IF total > 380 THEN
        SET info = '学习优秀';
        ELSEIF total >= 320 AND total <= 380 THEN
        SET info = '学习不错';
        ELSE
        SET info = '学习一般';
        END IF;
        END$

        DELIMITER ;

        -- 调用pro_test5存储过程
        CALL pro_test5(350,@info);

        CALL pro_test5((SELECT SUM(score) FROM student),@info);

        SELECT @info;
```

可以看到我们输入参数的传入可以直接传入350（在第35行），而对于输出参数的传递，我们这里是写入了@info，写入这个语句就意味着我们在当前会话中定义了一个info的变量，这个变量会在将info的值获取到，我们可以再后续的代码中通过到这个变量的值，这个名字是无所谓的，我们这里填入info只是为了便于人类读者的理解而已，并不是说一定要填入和我们内部定义的变量名一样的名字，获得该变量的值是在我们18行里的命令完成的，与我们在会话中定义的变量名没有关系

还有一点就是如果我们想要动态获取最大值的话，我们可以在传入参数里传入一个查询结果，查询到其最大值再传入，具体我们可以看第35行代码

- while循环的使用

直接看图吧，没啥好说的

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE73422930b28656468451d057781fa790.png)

示例代码如下，这里的目的是要求1-100的偶数和

```
/*
   while循环
   初始化语句;
   WHILE 条件判断语句 DO
      循环体语句;
      条件控制语句;
   END WHILE;
*/
-- 计算1~100之间的偶数和
        DELIMITER $

        CREATE PROCEDURE pro_test6()
        BEGIN
        -- 定义求和变量
        DECLARE result INT DEFAULT 0;
        -- 定义初始化变量
        DECLARE num INT DEFAULT 1;
        -- while循环
        WHILE num <= 100 DO
        IF num % 2 = 0 THEN
        SET result = result + num;
        END IF;

        SET num = num + 1;
        END WHILE;

        -- 查询求和结果
        SELECT result;
        END$

        DELIMITER ;


        -- 调用pro_test6存储过程
        CALL pro_test6();
```

- 存储函数的使用

那么我们终于到了我们这一章的最后一个内容了，就是关于存储函数的使用。先来看看相关的知识点

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE98e41284fbb8d0db9eb7c243a12ae92a.png)

存储函数跟存储过程也差不多，关键知识也是创建、调用和删除，其中创建的时候，其存储函数的关键字是FUNCTION，且存储函数必须有返回值，且在创建开头就要先指定返回值的类型，在BEGIN和END中间要有RETURN来返回对应的结果。

其调用存储函数的方式直接就是SELECT 函数名称(实际参数)，我认为其实这个所谓的调用SELECT其实就是获取其返回值然后将其展示出来，以前我们使用的是Call，展示是需要在函数内部自己定义的，而我们这里直接就可以将展示定义在外面了

另外必须有返回值的意思是其会返回一个值，不是说我们一定要传入什么值，这是两回事。

请看示例代码

```
/*
   创建存储函数
   CREATE FUNCTION 函数名称([参数 数据类型])
   RETURNS 返回值类型
   BEGIN
      执行的sql语句;
      RETURN 结果;
   END$
*/
-- 定义存储函数，获取学生表中成绩大于95分的学生数量
        DELIMITER $

        CREATE FUNCTION fun_test1()
        RETURNS INT
        BEGIN
        -- 定义变量
        DECLARE s_count INT;
        -- 查询成绩大于95分的数量，为s_count赋值
        SELECT COUNT(*) INTO s_count FROM student WHERE score > 95;
        -- 返回统计结果
        RETURN s_count;
        END$

        DELIMITER ;


/*
   调用函数
   SELECT 函数名称(实际参数);
*/
        -- 调用函数
        SELECT fun_test1();


/*
   删除函数
   DROP FUNCTION 函数名称;
*/
        -- 删除函数
        DROP FUNCTION fun_test1;
```

存储函数保存在函数文件夹中，如图所示

![](D:/Rolin的学习笔记/youdaonote-pull/youdaonote/youdaonote-images/WEBRESOURCE78c6acae0493979ddd98e3c1a0d111af.png)

